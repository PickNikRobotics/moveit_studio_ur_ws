<?xml version='1.0' encoding='UTF-8'?>
<root BTCPP_format="4" main_tree_to_execute="Command VFC">
  <!--//////////-->
  <BehaviorTree ID="Command VFC" _description="Uses the Velocity Force Controller (VFC) to move with a desired Cartesian velocity / force reference. Implements exit conditions for an exceeded force threshold or maximum distance travelled." _favorite="false" _subtreeOnly="true">
    <Control ID="Sequence" name="TopLevelSequence">
      <Action ID="CreateStampedWrench" stamped_wrench="{desired_wrench}" reference_frame="{tip_link}" torque_xyz="{torque_xyz}" force_xyz="{force_xyz}"/>
      <Action ID="CreateStampedTwist" reference_frame="{tip_link}" stamped_twist="{desired_twist}" angular_velocity_xyz="{angular_velocity_xyz}" linear_velocity_xyz="{linear_velocity_xyz}"/>
      <Action ID="CreateStampedPose" reference_frame="{tip_link}" stamped_pose="{initial_pose}"/>
      <Action ID="TransformPoseFrame" output_pose="{initial_pose}" input_pose="{initial_pose}"/>
      <Control ID="Parallel" failure_count="1" success_count="1">
        <Decorator ID="KeepRunningUntilFailure">
          <Control ID="Sequence">
            <Action ID="CreateStampedPose" reference_frame="{tip_link}" stamped_pose="{current_pose}"/>
            <Action ID="TransformPoseFrame" output_pose="{current_pose}" input_pose="{current_pose}"/>
            <Action ID="CalculatePoseOffset" source_pose="{initial_pose}" destination_pose="{current_pose}" source_to_destination_pose="{initial_pose_current}"/>
          </Control>
        </Decorator>
        <Action ID="ForceExceedsThreshold" minimum_consecutive_wrench_values="5" wrench_frame_name="tool0" hand_frame_name="{tip_link}" force_threshold="{force_threshold}"/>
        <Action ID="PublishVelocityForceCommand" force_controlled_axes="{force_controlled_axes}" wrench_gain="{wrench_gain}" velocity_controlled_axes="{velocity_controlled_axes}" publish_rate="50"/>
      </Control>
    </Control>
  </BehaviorTree>
  <TreeNodesModel>
    <SubTree ID="Command VFC">
      <input_port name="velocity_controlled_axes" default="1;0;0;0;0;0"/>
      <input_port name="linear_velocity_xyz" default="0.05;0.0;0.0"/>
      <input_port name="angular_velocity_xyz" default="0;0;0"/>
      <input_port name="force_controlled_axes" default="0;0;1;0;0;0"/>
      <input_port name="force_xyz" default="0;0;-2"/>
      <input_port name="torque_xyz" default="0;0;0"/>
      <input_port name="wrench_gain" default="0.01"/>
      <input_port name="distance_exit_condition" default="x&gt;0.2"/>
      <input_port name="force_threshold" default="50"/>
      <input_port name="tip_link" default="grasp_link"/>
    </SubTree>
  </TreeNodesModel>
</root>
