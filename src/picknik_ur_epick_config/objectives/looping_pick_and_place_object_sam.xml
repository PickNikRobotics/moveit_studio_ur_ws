<root BTCPP_format="4" main_tree_to_execute="Looping Pick and Place Object SAM">
  <!--//////////-->
  <BehaviorTree
    ID="Looping Pick and Place Object SAM"
    _description=""
    _favorite="true"
  >
    <Control ID="Sequence">
      <!--Set motion planning parameters-->
      <Action
        ID="ResetPlanningSceneObjects"
        apply_planning_scene_service="apply_planning_scene"
      />
      <Action
        ID="MoveGripperAction"
        gripper_command_action_name="/robotiq_gripper_controller/gripper_cmd"
        position="0.0"
      />
      <Action
        ID="LoadObjectiveParameters"
        config_file_name="looping_pick_and_place_object_sam_config.yaml"
        parameters="{parameters}"
      />
      <Action
        ID="InitializeMotionConstraints"
        constraints="{constraints}"
        constraints_name="empty_constraints"
      />
      <Action ID="Script" code="joint_group_name:='manipulator'" />
      <Decorator ID="KeepRunningUntilFailure">
        <Decorator
          ID="ForEachString"
          vector_in="Left;Right"
          out="{bin_name}"
          name="Alternate between L to R and R to L bin transfer"
        >
          <Decorator ID="ForceSuccess">
            <Decorator ID="KeepRunningUntilFailure">
              <Control ID="Sequence">
                <Control
                  ID="IfThenElse"
                  name="Set variables for transfer direction"
                >
                  <Decorator
                    ID="Precondition"
                    if="bin_name == 'Left'"
                    else="FAILURE"
                  >
                    <Action ID="AlwaysSuccess" />
                  </Decorator>
                  <Control ID="Sequence" name="Set variables for L to R">
                    <!--Picking from left bin-->
                    <Action
                      ID="Script"
                      code="look_at_bin_waypoint := 'Look at Left Box'"
                    />
                    <Action
                      ID="Script"
                      code="place_waypoint := 'Place in Right Bin'"
                    />
                    <Action
                      ID="Script"
                      code="crop_box_origin_frame_id := 'left_bin_crop_box'"
                    />
                    <Action
                      ID="Script"
                      code="crop_box_destination_frame_id := 'right_bin_crop_box'"
                    />
                    <Action
                      ID="Script"
                      code="bin_link_name := 'right_bin_link'"
                    />
                  </Control>
                  <Control ID="Sequence" name="Set variables for R to L">
                    <!--Picking from right bin-->
                    <Action
                      ID="Script"
                      code="look_at_bin_waypoint := 'Look at Right Box'"
                    />
                    <Action
                      ID="Script"
                      code="place_waypoint := 'Place in Left Bin'"
                    />
                    <Action
                      ID="Script"
                      code="crop_box_origin_frame_id := 'right_bin_crop_box'"
                    />
                    <Action
                      ID="Script"
                      code="crop_box_destination_frame_id := 'left_bin_crop_box'"
                    />
                    <Action
                      ID="Script"
                      code="bin_link_name := 'left_bin_link'"
                    />
                  </Control>
                </Control>
                <Action
                  ID="CreateStampedPose"
                  name="Crop frame for picking bin"
                  position_xyz="0.0;0.0;0.0"
                  orientation_xyzw="0.0;0.0;0.0;1.0"
                  stamped_pose="{crop_box_pose}"
                  reference_frame="{crop_box_origin_frame_id}"
                />
                <Control ID="Sequence" name="Pick and place logic">
                  <Decorator
                    ID="RetryUntilSuccessful"
                    num_attempts="3"
                    name="Attempt vision+pick planning up to 3 times"
                  >
                    <Control ID="Fallback" name="Pick logic">
                      <Control
                        ID="Sequence"
                        name="Perception, pick plan, pick execution"
                      >
                        <Control
                          ID="Sequence"
                          name="Move to overhead sense position"
                        >
                          <Action
                            ID="ResetPlanningSceneObjects"
                            apply_planning_scene_service="apply_planning_scene"
                          />
                          <SubTree
                            ID="Re-Zero Force-Torque Sensors"
                            _collapsed="true"
                          />
                          <SubTree
                            ID="Move to Waypoint"
                            _collapsed="true"
                            waypoint_name="{look_at_bin_waypoint}"
                            controller_names="/joint_trajectory_controller /robotiq_gripper_controller"
                            use_all_planners="false"
                            constraints="{constraints}"
                            joint_group_name="manipulator"
                            planner_interface="moveit_default"
                          />
                          <Action ID="ClearSnapshot" />
                        </Control>
                        <SubTree
                          ID="Detect Graspable Objects In ROI"
                          rgb_image_topic="/wrist_mounted_camera/color/image_raw"
                          point_cloud_topic="/wrist_mounted_camera/depth/color/points"
                          rgb_info_topic="/wrist_mounted_camera/color/camera_info"
                          get_masks_2d_action="/get_masks_2d_fastsam"
                          objects="{objects}"
                          _collapsed="true"
                          roi_pose="{crop_box_pose}"
                          roi_size="0.44;0.24;0.22"
                          name="Run mask model and project into pointcloud segments"
                        />
                        <Control ID="Sequence" name="Pick plan and execution">
                          <Action ID="Script" code="found_plan:=false" />
                          <Action ID="Script" code="picked_object := false" />
                          <Decorator ID="ForceSuccess">
                            <Decorator
                              ID="ForEachGraspableObject"
                              vector_in="{objects}"
                              out="{object}"
                              name="Attempt vacuum pick for each object"
                            >
                              <Control
                                ID="Sequence"
                                name="Attempt pick plan + execution"
                              >
                                <Decorator ID="ForceSuccess">
                                  <Control ID="Sequence" name="">
                                    <Action
                                      ID="InitializeMTCTask"
                                      task_id="pick_object"
                                      controller_names="/joint_trajectory_controller /robotiq_gripper_controller"
                                      task="{task}"
                                    />
                                    <Action
                                      ID="SetupMTCCurrentState"
                                      task="{task}"
                                    />
                                    <Action
                                      ID="SetupMTCApproachGrasp"
                                      parameters="{parameters}"
                                      target_object="{object}"
                                      monitored_stage="{monitored_stage}"
                                      task="{task}"
                                    />
                                    <Action
                                      ID="SetupMTCGenerateVacuumGrasps"
                                      parameters="{parameters}"
                                      target_object="{object}"
                                      monitored_stage="{monitored_stage}"
                                      task="{task}"
                                    />
                                    <Action
                                      ID="SetupMTCMoveAlongFrameAxis"
                                      task="{task}"
                                      hand_frame="grasp_link"
                                      axis_frame="grasp_link"
                                      axis_x="0.0"
                                      axis_y="0.0"
                                      axis_z="1.0"
                                      max_distance="0.1"
                                      min_distance="0.05"
                                      planning_group_name="manipulator"
                                      velocity_scale="0.25"
                                      acceleration_scale="1.0"
                                    />
                                    <Action
                                      ID="SetupMTCMoveAlongFrameAxis"
                                      task="{task}"
                                      hand_frame="grasp_link"
                                      axis_frame="grasp_link"
                                      axis_x="0.0"
                                      axis_y="0.0"
                                      axis_z="-1.0"
                                      max_distance="0.1"
                                      min_distance="0.09"
                                      planning_group_name="manipulator"
                                      velocity_scale="0.25"
                                      acceleration_scale="1"
                                    />
                                    <Control ID="Sequence">
                                      <Action
                                        ID="PlanMTCTask"
                                        solution="{solution}"
                                        task="{task}"
                                      />
                                      <Action
                                        ID="Script"
                                        code="found_plan = true"
                                        name="Set Plan Found"
                                      />
                                    </Control>
                                    <Decorator
                                      ID="Precondition"
                                      if="found_plan"
                                      else="FAILURE"
                                      name="Check if plan found"
                                    >
                                      <Action
                                        ID="AlwaysSuccess"
                                        name="Skip this object and try next one"
                                      />
                                    </Decorator>
                                    <Action
                                      ID="MoveGripperAction"
                                      gripper_command_action_name="/robotiq_gripper_controller/gripper_cmd"
                                      position="1.0"
                                    />
                                    <!--Monitor the trajectory execution for vacuum achieved (success) or trajectory completion (failure).-->
                                    <SubTree
                                      ID="Move Until Vacuum State"
                                      _collapsed="true"
                                      expected_vacuum_status="OBJECT_DETECTED_AT_MIN_PRESSURE"
                                      solution="{solution}"
                                      trajectory_execution_succeeded="{trajectory_execution_succeeded}"
                                    />
                                    <Decorator
                                      ID="Precondition"
                                      if="trajectory_execution_succeeded == true"
                                      else="SUCCESS"
                                      name="Check if trajectory finished (vacuum failed)"
                                    >
                                      <Action
                                        ID="AlwaysFailure"
                                        name="Skip this object and try next one"
                                      />
                                    </Decorator>
                                    <Action
                                      ID="Script"
                                      code="picked_object = true"
                                    />
                                    <Action
                                      ID="Script"
                                      code="object_in_hand:=object"
                                    />
                                  </Control>
                                </Decorator>
                                <Decorator
                                  ID="Precondition"
                                  name="Terminate ForEach if object pick was successful"
                                  if="picked_object == true"
                                  else="SUCCESS"
                                >
                                  <Action
                                    ID="AlwaysFailure"
                                    name="Attempt vacuum pick for next object"
                                  />
                                </Decorator>
                              </Control>
                            </Decorator>
                          </Decorator>
                          <Decorator
                            ID="Precondition"
                            name="Check if object picked"
                            if="picked_object == true"
                            else="FAILURE"
                          >
                            <Action
                              ID="AlwaysSuccess"
                              name="If fail: move back to overhead view and try again"
                            />
                          </Decorator>
                        </Control>
                      </Control>
                      <Control
                        ID="Sequence"
                        name="Turn off vacuum before re-trying"
                      >
                        <Action
                          ID="MoveGripperAction"
                          gripper_command_action_name="/robotiq_gripper_controller/gripper_cmd"
                          position="0.0"
                        />
                        <Action
                          ID="AlwaysFailure"
                          name="Move back to overhead view and try again"
                        />
                      </Control>
                    </Control>
                  </Decorator>
                  <!--Gently place via FTS while monitoring for unintentional drop via vacuum sensor-->
                  <Action
                    ID="CreateStampedPose"
                    stamped_pose="{collision_object_pose}"
                    reference_frame="epick_tip"
                    orientation_xyzw="0;0;0;1"
                    position_xyz="0;0;0.055"
                  />
                  <Action
                    ID="CreateGraspableObject"
                    cuboid_object="{collision_object}"
                    generate_side_faces="false"
                    generate_top_face="false"
                    dy="0.075"
                    dx="0.075"
                    generate_front_face="false"
                    object_id="object"
                    dz="0.1"
                    pose="{collision_object_pose}"
                  />
                  <Control
                    ID="Sequence"
                    name="Add grasped object to EEF to prevent collisions"
                  >
                    <Action
                      ID="InitializeMTCTask"
                      task_id="allow_bin_collision"
                      controller_names="/joint_trajectory_controller /robotiq_gripper_controller"
                      task="{allow_collision_task}"
                    />
                    <Action
                      ID="SetupMTCCurrentState"
                      task="{allow_collision_task}"
                    />
                    <Action
                      ID="SetupMTCUpdateObjectCollisionRule"
                      task="{allow_collision_task}"
                      allow_collision="true"
                      object="{collision_object}"
                      object_or_group_name="{bin_link_name}"
                    />
                    <Action
                      ID="SetupMTCUpdateObjectCollisionRule"
                      task="{allow_collision_task}"
                      object="{collision_object}"
                      object_or_group_name="gripper"
                      allow_collision="true"
                    />
                    <Action
                      ID="PlanMTCTask"
                      solution="{allow_collision_solution}"
                      task="{allow_collision_task}"
                    />
                    <Action
                      ID="ExecuteMTCTask"
                      solution="{allow_collision_solution}"
                    />
                  </Control>
                  <Control
                    ID="Sequence"
                    name="Plan place motion with upright constraint"
                  >
                    <Action
                      ID="RetrieveWaypoint"
                      waypoint_name="{place_waypoint}"
                      waypoint_joint_state="{place_joint_state}"
                      joint_group_name="{joint_group_name}"
                    />
                    <Action
                      ID="InitializeMotionConstraints"
                      constraints="{keep_upright_constraint}"
                      constraints_name="keep_upright_constraint"
                      name="Keep object upright so we can stack them"
                    />
                    <Action
                      ID="AppendOrientationConstraint"
                      constraints="{keep_upright_constraint}"
                      config_file_name="upright_constraint.yaml"
                    />
                    <Action
                      ID="InitializeMTCTask"
                      task_id="place_object"
                      controller_names="/joint_trajectory_controller /robotiq_gripper_controller"
                      task="{task_place}"
                    />
                    <Action ID="SetupMTCCurrentState" task="{task_place}" />
                    <Action
                      ID="SetupMTCAttachObject"
                      task="{task_place}"
                      object="{collision_object}"
                      frame_id="grasp_link"
                    />
                    <Action
                      ID="SetupMTCMoveAlongFrameAxis"
                      task="{task_place}"
                      hand_frame="grasp_link"
                      axis_frame="world"
                      axis_x="0.0"
                      axis_y="0.0"
                      axis_z="1.0"
                      max_distance="0.3"
                      min_distance="0.2"
                      planning_group_name="manipulator"
                      velocity_scale="0.5"
                      acceleration_scale="0.3"
                    />
                    <Action
                      ID="SetupMTCUpdateObjectCollisionRule"
                      task="{task_place}"
                      allow_collision="false"
                      object="{collision_object}"
                      object_or_group_name="{bin_link_name}"
                    />
                    <!--Randomly select one of four possible object placement locations to avoid tower stacking.-->
                    <Control ID="IfThenElse" name="Random place selection">
                      <Action ID="BiasedCoinFlip" success_probability="0.5" />
                      <Control ID="IfThenElse">
                        <Action ID="BiasedCoinFlip" success_probability="0.5" />
                        <Action
                          ID="CreateStampedPose"
                          stamped_pose="{place_pose}"
                          reference_frame="{crop_box_destination_frame_id}"
                          orientation_xyzw="1;0;0;0"
                          position_xyz="0.04;0.06;0.2"
                        />
                        <Action
                          ID="CreateStampedPose"
                          stamped_pose="{place_pose}"
                          reference_frame="{crop_box_destination_frame_id}"
                          orientation_xyzw="1;0;0;0"
                          position_xyz="0.04;-0.06;0.2"
                        />
                      </Control>
                      <Control ID="IfThenElse">
                        <Action ID="BiasedCoinFlip" success_probability="0.5" />
                        <Action
                          ID="CreateStampedPose"
                          stamped_pose="{place_pose}"
                          reference_frame="{crop_box_destination_frame_id}"
                          orientation_xyzw="1;0;0;0"
                          position_xyz="-0.04;0.06;0.2"
                        />
                        <Action
                          ID="CreateStampedPose"
                          stamped_pose="{place_pose}"
                          reference_frame="{crop_box_destination_frame_id}"
                          orientation_xyzw="1;0;0;0"
                          position_xyz="-0.04;-0.06;0.2"
                        />
                      </Control>
                    </Control>
                    <!--Free space move to overhead bin and then Cartesian move downward.-->
                    <Action
                      ID="SetupMTCMoveToPose"
                      task="{task_place}"
                      use_all_planners="false"
                      target_pose="{place_pose}"
                      planning_group_name="manipulator"
                      ik_frame="grasp_link"
                    />
                    <Action
                      ID="SetupMTCDetachObject"
                      task="{task_place}"
                      object="{object}"
                      frame_id="grasp_link"
                    />
                    <Action
                      ID="SetupMTCMoveAlongFrameAxis"
                      task="{task_place}"
                      hand_frame="grasp_link"
                      axis_frame="world"
                      axis_x="0.0"
                      axis_y="0.0"
                      axis_z="-1.0"
                      max_distance="0.2"
                      min_distance="0.001"
                      planning_group_name="manipulator"
                      velocity_scale="0.25"
                      acceleration_scale="0.3"
                    />
                    <Decorator
                      ID="RetryUntilSuccessful"
                      num_attempts="3"
                      name="Attempt place planning up to 3 times"
                    >
                      <Action
                        ID="PlanMTCTask"
                        solution="{solution_place}"
                        task="{task_place}"
                        _onSuccess="found_plan=true"
                      />
                    </Decorator>
                  </Control>
                  <!--Monitor the trajectory execution for gentle placement via FTS (success) or unintentional drop via vacuum sensor (failure).-->
                  <SubTree
                    ID="Move Until Vacuum State or Collision"
                    _collapsed="true"
                    solution="{solution_place}"
                    trajectory_execution_succeeded="{trajectory_execution_succeeded}"
                    expected_vacuum_status="NO_OBJECT_DETECTED"
                    force_threshold="7"
                  />
                  <Action
                    ID="MoveGripperAction"
                    gripper_command_action_name="/robotiq_gripper_controller/gripper_cmd"
                    position="0.0"
                    name="Release object"
                  />
                </Control>
              </Control>
            </Decorator>
          </Decorator>
        </Decorator>
      </Decorator>
    </Control>
  </BehaviorTree>
</root>
