<?xml version='1.0' encoding='UTF-8'?>
<root BTCPP_format="4" main_tree_to_execute="Visual Servo To Reference">
  <!-- ////////// -->
  <BehaviorTree ID="Visual Servo To Reference" _description="" _favorite="true" _hardcoded="false">
    <Control ID="Sequence">
      <Action ID="LoadObjectiveParameters" config_file_name="servo_reference.yaml" parameters="{servo_reference_parameters}"/>
      <Action ID="LoadObjectiveParameters" config_file_name="51mm_apriltag_detection_config.yaml" parameters="{tag_parameters}"/>
      <Action ID="GetCameraInfo" topic_name="/wrist_mounted_camera/color/camera_info" message_out="{camera_info}"/>
      <Action ID="ActivateControllers" controller_names="servo_controller"/>
      <Control ID="Sequence">
        <SubTree ID="Sample April Tag" _collapsed="true" num_samples="1" tag_id="2" apriltag_config="51mm_apriltag_detection_config.yaml" max_distance="0.02" max_rotation="0.2" avg_pose="{tag_pose}"/>
        <Action ID="TransformPoseFromYaml" input_pose="{tag_pose}" parameter_namespace="ServoReference" pose_parameters="{servo_reference_parameters}" output_pose="{reference_pose}"/>
        <Action ID="TransformPoseFrame" input_pose="{reference_pose}" target_frame_id="world" output_pose="{target_pose}"/>
      </Control>
      <Control ID="Parallel" success_count="2" failure_count="1">
        <Decorator ID="KeepRunningUntilFailure">
          <Control ID="Sequence">
            <SubTree ID="Sample April Tag" _collapsed="true" num_samples="1" tag_id="2" apriltag_config="51mm_apriltag_detection_config.yaml" max_distance="0.02" max_rotation="0.2" avg_pose="{tag_pose}"/>
            <Action ID="TransformPoseFromYaml" input_pose="{tag_pose}" parameter_namespace="ServoReference" pose_parameters="{servo_reference_parameters}" output_pose="{reference_pose}"/>
            <Action ID="TransformPoseFrame" input_pose="{reference_pose}" target_frame_id="world" output_pose="{target_pose}"/>
          </Control>
        </Decorator>
        <Action ID="AveragePoseStamped" run_continuously="true" num_samples="5" max_distance="0.06" max_rotation="0.4" pose_sample="{target_pose}" avg_pose="{target_pose_avg}"/>
        <Action ID="ServoPose" planning_group_name="manipulator" target_pose="{target_pose_avg}" gain="1.0" max_translational_vel="0.2" max_rotational_vel="0.2" publish_rate="20"/>
      </Control>
    </Control>
  </BehaviorTree>
</root>
