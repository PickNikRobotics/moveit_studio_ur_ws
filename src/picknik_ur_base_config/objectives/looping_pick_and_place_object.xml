<?xml version='1.0' encoding='UTF-8'?>
<root BTCPP_format="4" main_tree_to_execute="Looping Pick and Place Object">
  <!-- ////////// -->
  <BehaviorTree ID="Looping Pick and Place Object" _description="Repeatedly attempt to detect and grasp a cuboid from a target bin, and drop it in the target area." _favorite="true">
    <Control ID="Sequence">
      <Action ID="LoadObjectiveParameters" config_file_name="looping_pick_and_place_object_config.yaml" parameters="{parameters}"/>
      <Action ID="ResetPlanningSceneObjects" apply_planning_scene_service="apply_planning_scene"/>
      <Action ID="MoveGripperAction" gripper_command_action_name="/robotiq_gripper_controller/gripper_cmd" position="0.0"/>
      <Action ID="MoveToJointState" waypoint_name="Look at Pick and Place Zone" planning_group_name="manipulator" controller_names="/joint_trajectory_controller /robotiq_gripper_controller" use_all_planners="false"/>
      <Decorator ID="KeepRunningUntilFailure">
        <Control ID="Fallback" name="TryGraspOuter">
          <Decorator ID="KeepRunningUntilFailure">
            <Decorator ID="ForEachString" name="IterateThroughPlaceWaypoints" vector_in="Place Right;Place Left" out="{place_waypoint}">
              <Control ID="Sequence">
                <Decorator ID="RetryUntilSuccessful" num_attempts="5">
                  <Control ID="Fallback" name="TryGraspInner">
                    <Control ID="Sequence">
                      <Action ID="ClearSnapshot"/>
                      <Action ID="ResetPlanningSceneObjects" apply_planning_scene_service="apply_planning_scene"/>
                      <Action ID="GetPointCloud" topic_name="/wrist_mounted_camera/depth/color/points" message_out="{point_cloud}"/>
                      <Action ID="FindSingularCuboids" point_cloud="{point_cloud}" parameters="{parameters}" detected_shapes="{cuboids}"/>
                      <Control ID="Sequence">
                        <Decorator ID="ForceSuccess">
                          <Decorator ID="ForEachCollisionObject" vector_in="{cuboids}" out="{cuboid_object}">
                            <Control ID="Sequence">
                              <Action ID="AlwaysFailure"/>
                            </Control>
                          </Decorator>
                        </Decorator>
                      </Control>
                      <Action ID="ModifyObjectInPlanningScene" object="{cuboid_object}" apply_planning_scene_service="/apply_planning_scene"/>
                      <Action ID="UpdatePlanningSceneService" point_cloud="{point_cloud}" point_cloud_service="/point_cloud_service"/>
                      <Action ID="InitializeMTCTask" task_id="looping_pick_and_place_object" controller_names="/joint_trajectory_controller /robotiq_gripper_controller" task="{task}"/>
                      <Action ID="SetupMTCCurrentState" task="{task}"/>
                      <Action ID="SetupMTCApproachGrasp" parameters="{parameters}" cuboid_object="{cuboid_object}" monitored_stage="{monitored_stage}" task="{task}"/>
                      <Action ID="SetupMTCGenerateCuboidGrasps" parameters="{parameters}" cuboid_object="{cuboid_object}" monitored_stage="{monitored_stage}" task="{task}"/>
                      <Action ID="SetupMTCRetractFromGrasp" parameters="{parameters}" cuboid_object="{cuboid_object}" task="{task}"/>
                      <Action ID="PlanMTCTask" solution="{solution}" task="{task}"/>
                      <Action ID="ExecuteMTCTask" solution="{solution}"/>
                    </Control>
                    <Control ID="Sequence">
                      <Action ID="WaitForDuration" delay_duration="1"/>
                      <Action ID="AlwaysFailure"/>
                    </Control>
                  </Control>
                </Decorator>
                <Action ID="MoveToJointState" waypoint_name="Look at Pick and Place Zone" planning_group_name="manipulator" controller_names="/joint_trajectory_controller /robotiq_gripper_controller" use_all_planners="false"/>
                <Action ID="MoveToJointState" waypoint_name="{place_waypoint}" planning_group_name="manipulator" controller_names="/joint_trajectory_controller /robotiq_gripper_controller" use_all_planners="false"/>
                <Action ID="MoveGripperAction" gripper_command_action_name="/robotiq_gripper_controller/gripper_cmd" position="0.0"/>
                <Action ID="MoveToJointState" waypoint_name="Look at Pick and Place Zone" planning_group_name="manipulator" controller_names="/joint_trajectory_controller /robotiq_gripper_controller" use_all_planners="false"/>
              </Control>
            </Decorator>
          </Decorator>
          <Control ID="Sequence">
            <Action ID="ResetPlanningSceneObjects" apply_planning_scene_service="/apply_planning_scene"/>
            <Action ID="MoveToJointState" waypoint_name="Look at Pick and Place Zone" planning_group_name="manipulator" controller_names="/joint_trajectory_controller /robotiq_gripper_controller" use_all_planners="false"/>
            <Action ID="WaitForDuration" delay_duration="5"/>
            <Action ID="AlwaysSuccess"/>
          </Control>
        </Control>
      </Decorator>
    </Control>
  </BehaviorTree>
</root>
