<?xml version='1.0' encoding='UTF-8'?>
<root BTCPP_format="4" main_tree_to_execute="Open Door Lever Handle ML">
  <!-- ////////// -->
  <BehaviorTree ID="Open Door Lever Handle ML" _description="Attempts to open a door with a lever handle using ML." _favorite="false" _hardcoded="false">
    <Control ID="Sequence" name="TopLevelSequence">
      <!-- Load the parameters needed for this behavior -->
      <Action ID="LoadObjectiveParameters" config_file_name="config_open_door_lever_handle_MTC.yaml" parameters="{parameters}"/>
      <!-- Update the admittance controller and reset the FTS -->
      <SubTree ID="Re-Zero Force-Torque Sensors" _collapsed="true"/>
      <SubTree ID="Update Admittance Controller" _collapsed="true"/>
      <!-- Look at the desired location where objects (door) will be present -->
      <Action ID="MoveToWaypoint" waypoint_name="Right Wall" planning_group_name="manipulator" controller_names="/joint_trajectory_controller /robotiq_gripper_controller" use_all_planners="true" constraints=""/>
      <SubTree ID="GetDoorGraspableObject" _collapsed="true"/>
      <SubTree ID="GetHandleGraspableObject" _collapsed="true"/>
      <SubTree ID="GetHingeLineSegment" _collapsed="true"/>
      <Action ID="GetGraspAndTwistSubframes" grasp_rotation_z_radians="1.5708" target_grasp_pose="{grasp_pose}" grasp_and_twist_subframes="{grasp_and_twist_subframes}"/>
      <Decorator ID="ForEachObjectSubframe" vector_in="{grasp_and_twist_subframes}" out="{subframe}">
        <Control ID="Sequence">
          <Action ID="AddSubframeToObject" subframe="{subframe}" graspable_object="{graspable_object}"/>
        </Control>
      </Decorator> 
      <!-- Now get the first graspable object (which should have subframes added) and do MTC -->
      <Decorator ID="ForceSuccess">
        <Decorator ID="ForEachGraspableObject" vector_in="{door_objects}" out="{door_object}">
          <Action ID="AlwaysFailure"/>
        </Decorator>
      </Decorator>
      <Control ID="Sequence">
        <Action ID="MoveGripperAction" gripper_command_action_name="/robotiq_gripper_controller/gripper_cmd" position="0.0"/>
        <Action ID="ModifyObjectInPlanningScene" object="{graspable_object}" apply_planning_scene_service="/apply_planning_scene"/>
        <Control ID="Sequence" name="OpenDoorLeverHandleMTC">
          <Action ID="InitializeMTCTask" task_id="open_door_lever_handle_ml" controller_names="/joint_trajectory_controller /robotiq_gripper_controller" task="{open_door_affordance_task}"/>
          <Action ID="SetupMTCCurrentState" task="{open_door_affordance_task}"/>
          <Action ID="SetupMTCGraspAndTwistThenMoveAlongArcPush" graspable_object="{graspable_object}" parameters="{parameters}" task="{open_door_affordance_task}" handle_length="{handle_length}" handle_z_offset="{handle_z_offset}"/>
          <Action ID="PlanMTCTask" task="{open_door_affordance_task}" solution="{open_door_affordance_solution}"/>
          <Control ID="Fallback">
            <Decorator ID="Inverter">
              <Action ID="IsUserAvailable"/>
            </Decorator>
            <Action ID="WaitForUserTrajectoryApproval" solution="{open_door_affordance_solution}"/>
          </Control>
          <Action ID="ExecuteMTCTask" solution="{open_door_affordance_solution}"/>
        </Control>
      </Control>
    </Control>
  </BehaviorTree>
</root>
