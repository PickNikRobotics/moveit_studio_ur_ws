<?xml version='1.0' encoding='UTF-8'?>
<root BTCPP_format="4" main_tree_to_execute="Open Door Fixed Handle ML">
  <!-- ////////// -->
  <BehaviorTree ID="Open Door Fixed Handle ML" _description="Attempts to open a door with a fixed handle (such as cabinet doors) using ML." _favorite="true" _hardcoded="false">
    <Control ID="Sequence" name="TopLevelSequence">
      <!-- Load the objectives needed for this behavior -->
      <!-- Update the admittance controller and reset the FTS -->
      <!-- Look at the desired location where objects (door) will be present -->
      <!-- Get the door GraspableObject(s) -->
      <!-- TODO: can we combine the vectors of masks2d so we only have to call this chunk once? -->
      <!-- Get the masks for the handle subframe of the door GraspableObject -->
      <!-- Get the cuboid objects from our masks, then add them to the door GraspableObject -->
      <!-- // FindSingularCuboids // GetObjectFromMasks -->
      <!-- Get the masks for the hinge subframes of the door GraspableObject -->
      <!-- Get the cuboid objects from our masks, then add them to the door GraspableObject -->
      <!-- // FindSingularCuboids // GetObjectFromMasks -->
      <!-- Add the subframes to the Object-->
      <!-- Helper behavior to convert poses into subframes that adhere to the expected axis convention -->
      <!-- Now for each door graspable object (with subframes added) -->
      <Action ID="LoadObjectiveParameters" config_file_name="config_open_door_fixed_handle_MTC.yaml" parameters="{parameters}"/>
      <SubTree ID="Re-Zero Force-Torque Sensors" _collapsed="true"/>
      <SubTree ID="Update Admittance Controller" _collapsed="true"/>
      <Action ID="MoveToWaypoint" waypoint_name="Right Wall" planning_group_name="manipulator" controller_names="/joint_trajectory_controller /robotiq_gripper_controller" use_all_planners="true" constraints=""/>
      <Action ID="GetCameraInfo" topic_name="/wrist_mounted_camera/color/camera_info" message_out="{camera_info}"/>
      <Action ID="GetPointCloud" topic_name="/wrist_mounted_camera/depth/color/points" message_out="{point_cloud}"/>
      <Action ID="UpdatePlanningSceneService" point_cloud="{point_cloud}" point_cloud_service="/point_cloud_service"/>
      <Action ID="SendPointCloudToUI" point_cloud="{point_cloud}" sensor_name="scene_scan_camera" point_cloud_uuid="" pcd_topic="/pcd_pointcloud_captures"/>
      <Action ID="GetImage" topic_name="/wrist_mounted_camera/color/image_raw" message_out="{image}"/>
      <Action ID="GetMasks2DAction" image="{image}" action_name="get_masks_2d_maskrcnn" min_confidence="0.8" max_nms_iou="0.8" min_relative_area="0" max_relative_area="1" masks2d="{masks2d}" valid_classes="space booth cabinet door"/>
      <Action ID="GetMasks3DFromMasks2D" point_cloud="{point_cloud}" masks2d="{masks2d}" camera_info="{camera_info}" masks3d="{masks3d}"/>
      <Action ID="LogMessage" message="Found a mask for the door." log_level="warn"/>
      <Decorator ID="ForEachMask3D" vector_in="{masks3d}" out="{mask3d}">
        <Control ID="Sequence">
          <Action ID="GetPointCloudFromMask3D" point_cloud="{point_cloud}" mask3d="{mask3d}" point_cloud_fragment="{point_cloud_fragment}"/>
          <Action ID="SendPointCloudToUI" point_cloud="{point_cloud_fragment}" sensor_name="scene_scan_camera" point_cloud_uuid="" pcd_topic="/pcd_pointcloud_captures"/>
        </Control>
      </Decorator>
      <Action ID="GetGraspableObjectsFromMasks3D" point_cloud="{point_cloud}" masks3d="{masks3d}" base_frame="world" plane_inlier_threshold="0.01" minimum_face_area="0.000625" face_separation_threshold="0.01" graspable_objects="{graspable_objects}" name="GetDoorGraspableObjects"/>
      <Action ID="GetMasks2DAction" image="{image}" action_name="get_masks_2d_maskrcnn" min_confidence="0.8" max_nms_iou="0.8" min_relative_area="0" max_relative_area="1" masks2d="{handle_masks2d}" valid_classes="pull handle"/>
      <Action ID="GetMasks3DFromMasks2D" point_cloud="{point_cloud}" masks2d="{handle_masks2d}" camera_info="{camera_info}" masks3d="{masks3d}"/>
      <Action ID="LogMessage" message="Found a mask for the pull handle." log_level="warn"/>
      <Decorator ID="ForEachMask3D" vector_in="{masks3d}" out="{mask3d}">
        <Control ID="Sequence">
          <Action ID="GetPointCloudFromMask3D" point_cloud="{point_cloud}" mask3d="{mask3d}" point_cloud_fragment="{point_cloud_fragment}"/>
          <Action ID="SendPointCloudToUI" point_cloud="{point_cloud_fragment}" sensor_name="scene_scan_camera" point_cloud_uuid="" pcd_topic="/pcd_pointcloud_captures"/>
        </Control>
      </Decorator>
      <Action ID="GetGraspableObjectsFromMasks3D" point_cloud="{point_cloud}" masks3d="{masks3d}" base_frame="world" plane_inlier_threshold="0.005" minimum_face_area="0.000625" face_separation_threshold="0.005" graspable_objects="{graspable_objects}" name="GetHandleGraspableObjects"/>
      <Decorator ID="ForEachGraspableObject" vector_in="{graspable_objects}" out="{object}">
        <Action ID="ConvertObjectToPoseStamped" graspable_object="{object}" pose="{grasp_pose}"/>
      </Decorator>
      <Action ID="GetMasks2DAction" image="{image}" action_name="get_masks_2d_maskrcnn" min_confidence="0.8" max_nms_iou="0.8" min_relative_area="0" max_relative_area="1" masks2d="{hinge_masks2d}" valid_classes="space booth cabinet hinge"/>
      <Action ID="GetMasks3DFromMasks2D" point_cloud="{point_cloud}" masks2d="{hinge_masks2d}" camera_info="{camera_info}" masks3d="{masks3d}"/>
      <Action ID="LogMessage" message="Found masks for the door hinge." log_level="warn"/>
      <Decorator ID="ForEachMask3D" vector_in="{masks3d}" out="{mask3d}">
        <Control ID="Sequence">
          <Action ID="GetPointCloudFromMask3D" point_cloud="{point_cloud}" mask3d="{mask3d}" point_cloud_fragment="{point_cloud_fragment}"/>
          <Action ID="SendPointCloudToUI" point_cloud="{point_cloud_fragment}" sensor_name="scene_scan_camera" point_cloud_uuid="" pcd_topic="/pcd_pointcloud_captures"/>
        </Control>
      </Decorator>
      <Action ID="GetGraspableObjectsFromMasks3D" point_cloud="{point_cloud}" masks3d="{masks3d}" base_frame="world" plane_inlier_threshold="0.01" minimum_face_area="0.000625" face_separation_threshold="0.01" graspable_objects="{graspable_objects}" name="GetHingeGraspableObjects"/>
      <Decorator ID="ForEachGraspableObject" vector_in="{graspable_objects}" out="{object}">
        <Control ID="IfThenElse">
          <Action ID="Script" code="first_pose_received == false"/>
          <Control ID="Sequence">
            <Action ID="LogMessage" message="Getting First Hinge Pose" log_level="info"/>
            <Action ID="ConvertObjectToPoseStamped" graspable_object="{object}" pose="{screw_1_pose}"/>
            <Action ID="Script" code="first_pose_received := true"/>
          </Control>
          <Control ID="Sequence">
            <Action ID="LogMessage" message="Getting Second Hinge Pose" log_level="info"/>
            <Action ID="ConvertObjectToPoseStamped" graspable_object="{object}" pose="{screw_2_pose}"/>
          </Control>
        </Control>
      </Decorator>
      <Action ID="GetMoveAlongArcSubframes" target_grasp_pose="{grasp_pose}" hinge_axis_pose_start="{screw_1_pose}" hinge_axis_pose_end="{screw_2_pose}" move_along_arc_subframes="{move_along_arc_subframes}"/>
      <Decorator ID="ForEachObjectSubframe" vector_in="{move_along_arc_subframes}" out="{subframe}">
        <Control ID="Sequence">
          <Action ID="AddSubframeToObject" subframe="{subframe}" graspable_object="{graspable_object}"/>
        </Control>
      </Decorator>
      <Decorator ID="ForEachGraspableObject" vector_in="{graspable_objects}" out="{graspable_object}">
        <Control ID="Sequence">
          <!-- Open Gripper -->
          <!-- Plan and optionally Execute MTC task -->
          <Action ID="MoveGripperAction" gripper_command_action_name="/robotiq_gripper_controller/gripper_cmd" position="0.0"/>
          <Action ID="ModifyObjectInPlanningScene" object="{graspable_object}" apply_planning_scene_service="/apply_planning_scene"/>
          <Control ID="Sequence" name="OpenDoorFixedHandleMTC">
            <Action ID="InitializeMTCTask" task_id="open_door_fixed_handle_ml" controller_names="/joint_trajectory_controller /robotiq_gripper_controller" task="{open_door_affordance_task}"/>
            <Action ID="SetupMTCCurrentState" task="{open_door_affordance_task}"/>
            <Action ID="SetupMTCGraspThenMoveAlongArcPull" graspable_object="{graspable_object}" parameters="{parameters}" task="{open_door_affordance_task}"/>
            <Action ID="PlanMTCTask" task="{open_door_affordance_task}" solution="{open_door_affordance_solution}"/>
            <Control ID="Fallback">
              <Decorator ID="Inverter">
                <Action ID="IsUserAvailable"/>
              </Decorator>
              <Action ID="WaitForUserTrajectoryApproval" solution="{open_door_affordance_solution}"/>
            </Control>
            <Action ID="ExecuteMTCTask" solution="{open_door_affordance_solution}"/>
          </Control>
        </Control>
      </Decorator>
    </Control>
  </BehaviorTree>
</root>
